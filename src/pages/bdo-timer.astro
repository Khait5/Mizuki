---
import { siteConfig } from "../config";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import Icon from "../components/misc/Icon.astro";
import IconifyLoader from "../components/misc/IconifyLoader.astro";

// Reference Timezone for BDO EU (CET/CEST)
const BDO_TIMEZONE = "Europe/Berlin"; 
const currentDateTime = new Date();

// --- BDO World Boss Timers Data (Fictional Example Updated 2025 EU) ---
// Boss schedules are fixed weekly. 'day' is the day index (0=Sun, 6=Sat), 'hour' is in BDO Server Time (CET/CEST).
const bossSchedule = [
    // Monday (1)
    { day: 1, hour: 17, boss: "Karanda", icon: "mdi:feather" },
    { day: 1, hour: 21, boss: "Kzarka", icon: "mdi:sword-cross" },
    // Tuesday (2)
    { day: 2, hour: 13, boss: "Garmoth", icon: "mdi:dragon-fire" },
    { day: 2, hour: 20, boss: "Kutum", icon: "mdi:skull" },
    // Wednesday (3)
    { day: 3, hour: 17, boss: "Nouver", icon: "mdi:wind-turbine" },
    { day: 3, hour: 21, boss: "Vell (Weekly)", icon: "mdi:ship-wheel" },
    // Thursday (4)
    { day: 4, hour: 16, boss: "Offin", icon: "mdi:tree" },
    { day: 4, hour: 22, boss: "Kzarka", icon: "mdi:sword-cross" },
    // Friday (5)
    { day: 5, hour: 19, boss: "Kutum", icon: "mdi:skull" },
    { day: 5, hour: 23, boss: "Karanda", icon: "mdi:feather" },
    // Saturday (6) - Weekend has more spawns
    { day: 6, hour: 14, boss: "Nouver", icon: "mdi:wind-turbine" },
    { day: 6, hour: 18, boss: "Offin", icon: "mdi:tree" },
    { day: 6, hour: 22, boss: "Garmoth", icon: "mdi:dragon-fire" },
    // Sunday (0)
    { day: 0, hour: 15, boss: "Kutum", icon: "mdi:skull" },
    { day: 0, hour: 19, boss: "Karanda", icon: "mdi:feather" },
];

/**
 * Function to get the next bosses from the list.
 * Assumes bosses spawn 15 minutes after the hour indicated.
 */
function getNextBosses(currentTime: Date, schedule: typeof bossSchedule) {
    const nextBosses = [];
    const nowTimestamp = currentTime.getTime();
    
    // Convert current time to BDO server timezone
    const bdoTime = new Date(currentTime.toLocaleString("en-US", { timeZone: BDO_TIMEZONE }));
    
    // Iterate through the schedule to find the immediate next bosses
    for (let i = 0; i < schedule.length; i++) {
        const boss = schedule[i];
        
        // Calculate the boss time on the current day
        let bossTime = new Date(bdoTime);
        bossTime.setHours(boss.hour, 15, 0, 0); // Spawn time is H:15

        // Adjust the date if the boss is on a different day of the week
        const dayDifference = (boss.day - bdoTime.getDay() + 7) % 7;
        bossTime.setDate(bdoTime.getDate() + dayDifference);

        // If the boss time is in the past, move it to the next week
        if (bossTime.getTime() < nowTimestamp) {
            bossTime.setDate(bossTime.getDate() + 7);
        }

        const msUntilBoss = bossTime.getTime() - nowTimestamp;

        // Only consider bosses within the next week
        if (msUntilBoss > 0 && msUntilBoss < 7 * 24 * 60 * 60 * 1000) {
            nextBosses.push({
                ...boss,
                spawnTime: bossTime,
                msUntilSpawn: msUntilBoss,
            });
        }
    }

    // Sort by the nearest spawn time
    nextBosses.sort((a, b) => a.msUntilSpawn - b.msUntilSpawn);

    return nextBosses.slice(0, 5); // Show the next 5 bosses
}

const upcomingBosses = getNextBosses(currentDateTime, bossSchedule);


// --- BDO Day/Night Cycle Timer (Logic remains the same, texts are translated) ---
const BDO_EPOCH = new Date("2025-01-01T00:00:00.000Z").getTime();
const DAY_PHASE = 4 * 60 * 60 * 1000; // 4 hours
const NIGHT_PHASE = 4 * 60 * 60 * 1000; // 4 hours
const TOTAL_CYCLE_BDO = DAY_PHASE + NIGHT_PHASE; // 8 hours

// Calculate elapsed time since Epoch (in BDO timezone)
const nowInBDO = new Date(currentDateTime.toLocaleString("en-US", { timeZone: BDO_TIMEZONE }));
const msSinceEpoch = nowInBDO.getTime() - BDO_EPOCH;
const msIntoCycle = msSinceEpoch % TOTAL_CYCLE_BDO;

let currentPhase = { name: "Calculating...", color: "bg-gray-500/20 text-gray-700", msRemaining: 0 };
let nextPhase = { name: "Calculating...", color: "bg-gray-500/20 text-gray-700" };


if (msIntoCycle < DAY_PHASE) {
    currentPhase.name = "Day";
    currentPhase.color = "bg-yellow-500/20 text-yellow-700 dark:text-yellow-400";
    currentPhase.msRemaining = DAY_PHASE - msIntoCycle;
    nextPhase.name = "Night";
    nextPhase.color = "bg-blue-800/20 text-blue-400 dark:text-blue-300";
} else {
    currentPhase.name = "Night";
    currentPhase.color = "bg-blue-800/20 text-blue-400 dark:text-blue-300";
    currentPhase.msRemaining = TOTAL_CYCLE_BDO - msIntoCycle;
    nextPhase.name = "Day";
    nextPhase.color = "bg-yellow-500/20 text-yellow-700 dark:text-yellow-400";
}

// Helper to format milliseconds into H:M:S
const formatTime = (ms: number) => {
    const totalSeconds = Math.floor(ms / 1000);
    const totalMinutes = Math.floor(totalSeconds / 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
};


// Check if the BDO Timer page is enabled (Crucial for the redirect issue)
if (!siteConfig.featurePages.bdoTimer) {
	return Astro.redirect("/404/");
}

const title = "BDO Timer";
const subtitle = "World Boss and Day/Night Cycle (EU)";
---

<MainGridLayout title={title} description={subtitle}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <div class="flex flex-col items-start justify-center mb-8">
        <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                  before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
          BDO Timers (Europe)
        </h1>
        <p class="text-lg text-black/60 dark:text-white/60">
          World Boss Schedules and Day/Night Cycle. Server Time: {new Date().toLocaleTimeString('en-US', { timeZone: BDO_TIMEZONE, hour: '2-digit', minute: '2-digit', timeZoneName: 'short' })}
        </p>
      </div>

      <div class="mb-8">
        <h2 class="text-2xl font-bold text-black/90 dark:text-white/90 mb-4 relative
                  before:w-1 before:h-6 before:rounded-md before:bg-red-500
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
          Upcoming World Bosses
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {upcomingBosses.map((boss) => (
            <div class="bg-transparent rounded-lg border border-black/10 dark:border-white/10 p-4 hover:shadow-lg transition-shadow duration-300">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 bg-red-600/20 text-red-700 dark:text-red-400">
                  <Icon icon={boss.icon} class="text-xl" />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold text-black/90 dark:text-white/90 truncate">
                    {boss.boss}
                  </h3>
                  <p class="text-black/60 dark:text-white/60 text-sm">
                    {boss.spawnTime.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' })} at {boss.spawnTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: BDO_TIMEZONE })}
                  </p>
                  <p class="text-red-700 dark:text-red-400 font-bold text-sm" data-countdown={boss.spawnTime.getTime()}>
                    Remaining: {formatTime(boss.msUntilSpawn)} 
                  </p>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div class="mb-8">
        <h2 class="text-2xl font-bold text-black/90 dark:text-white/90 mb-4 relative
                  before:w-1 before:h-6 before:rounded-md before:bg-yellow-500
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
          Day/Night Cycle Timer
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class={`rounded-lg border border-black/10 dark:border-white/10 p-6 ${currentPhase.color}`}>
                <h3 class="text-xl font-bold mb-2">Current Phase</h3>
                <p class="text-3xl font-extrabold">{currentPhase.name}</p>
                <p class="mt-2 text-sm text-black/70 dark:text-white/70">
                    Ends in: 
                    <span class="font-bold text-black/90 dark:text-white/90 ml-1" data-countdown-cycle={currentPhase.msRemaining}>
                        {formatTime(currentPhase.msRemaining)}
                    </span>
                </p>
            </div>
            <div class={`rounded-lg border border-black/10 dark:border-white/10 p-6 ${nextPhase.color}`}>
                <h3 class="text-xl font-bold mb-2">Next Phase</h3>
                <p class="text-3xl font-extrabold">{nextPhase.name}</p>
                <p class="mt-2 text-sm text-black/70 dark:text-white/70">
                    Starts immediately after.
                </p>
            </div>
        </div>
      </div>
      
      <script>
        // CLIENT-SIDE JAVASCRIPT for Live Countdowns
        document.addEventListener('astro:load', () => {
            function updateCountdown() {
                const now = new Date().getTime();

                // 1. Boss Timers
                document.querySelectorAll('[data-countdown]').forEach(el => {
                    const spawnTime = parseInt(el.dataset.countdown);
                    let msUntilSpawn = spawnTime - now;

                    if (msUntilSpawn < 0) {
                        el.textContent = 'Spawning now or already spawned!';
                        // For a more advanced timer, you would need to recalculate the next spawn.
                    } else {
                        const totalSeconds = Math.floor(msUntilSpawn / 1000);
                        const totalMinutes = Math.floor(totalSeconds / 60);
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        const seconds = totalSeconds % 60;
                        el.textContent = `Remaining: ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
                    }
                });

                // 2. Day/Night Cycle Timer
                const BDO_TIMEZONE = "Europe/Berlin";
                const BDO_EPOCH = new Date("2025-01-01T00:00:00.000Z").getTime();
                const DAY_PHASE = 4 * 60 * 60 * 1000;
                const NIGHT_PHASE = 4 * 60 * 60 * 1000;
                const TOTAL_CYCLE_BDO = DAY_PHASE + NIGHT_PHASE;

                const nowInBDOString = new Date().toLocaleString("en-US", { timeZone: BDO_TIMEZONE });
                const nowInBDO = new Date(nowInBDOString).getTime();
                const msSinceEpoch = nowInBDO - BDO_EPOCH;
                const msIntoCycle = msSinceEpoch % TOTAL_CYCLE_BDO;
                
                let msRemaining;

                if (msIntoCycle < DAY_PHASE) {
                    // It is DAY
                    msRemaining = DAY_PHASE - msIntoCycle;
                } else {
                    // It is NIGHT
                    msRemaining = TOTAL_CYCLE_BDO - msIntoCycle;
                }
                
                const totalSeconds = Math.floor(msRemaining / 1000);
                const totalMinutes = Math.floor(totalSeconds / 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const seconds = totalSeconds % 60;

                const cycleEl = document.querySelector('[data-countdown-cycle]');
                if (cycleEl) {
                    cycleEl.textContent = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
                }

            }

            // Update every second
            setInterval(updateCountdown, 1000);
            updateCountdown(); // Execute immediately on load
        });
      </script>

    </div>
  </div>
</MainGridLayout>